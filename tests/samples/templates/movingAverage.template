#! Generated by VisualDCT v2.7.1-SNAPSHOT

# Database to calculate a moving average of a signal
# over a configurable number of samples.
# 
# Macros:
# % macro, P, device name
# % macro, INP, PV name of the signal being averaged. This must update on a periodic scan.
# % macro, TYPE, Field type of this PV (e.g. DOUBLE or LONG)
# % macro, ADEL, Archiver deadband
record(aSub, "$(P):CALCMOVINGAV") {
  field(SNAM, "calcAverage")
  field(INPA, "$(P):NOSAMPLES.VAL")
  field(INPB, "$(INP) CP")
  field(FTA, "LONG")
  field(FTB, "$(TYPE)")
  field(FTVA, "$(TYPE)")
  field(DESC, "Calculates moving average")
  field(SDIS, "$(P):DISABLEMOVINGAV.VAL")
  field(INPC, "$(P):RESETFLAG.VAL")
  field(FTC, "LONG")
  field(OUTA, "$(P):MOVINGAVERAGE PP")
  field(OUTB, "$(P):RESETFLAG.VAL")
  field(FTVB, "LONG")
  field(OUTC, "$(P):CHECKDONE.B PP")
  field(FTVC, "LONG")
  field(INAM, "initAverage")
}

# %archiver 0.1 Monitor
record(ai, "$(P):MOVINGAVERAGE") {
  field(DESC, "Moving average")
  field(ADEL, "$(ADEL)")
}

# %autosave 1
record(ao, "$(P):MOVINGINTTIME") {
  field(DESC, "Integration time")
  field(VAL, "0.1")
  field(OUT, "$(P):NOSAMPLES.A PP")
  field(PREC, "1")
  field(EGU, "s")
  field(LOPR, "0.1")
  field(HOPR, "60")
  field(PINI, "YES")
}

# Busy record to implement callback when moving average has reached
# required number of samples.
record(busy, "$(P):STARTAV") {
}

# Set to 1 to disable the moving average code.
# %autosave 1
record(bo, "$(P):DISABLEMOVINGAV") {
  field(VAL, "0")
  field(ZNAM, "ENABLE")
  field(ONAM, "DISABLE")
}

record(seq, "$(P):TRIGGERRESET") {
  field(SELM, "All")
  field(DOL1, "1")
  field(LNK1, "$(P):DISABLEMOVINGAV PP")
  field(DOL2, "1")
  field(LNK2, "$(P):RESETFLAG.VAL PP")
  field(DOL3, "0")
  field(LNK3, "$(P):DISABLEMOVINGAV PP")
}

# Checks if required number of samples has been obtained.
record(calcout, "$(P):CHECKDONE") {
  field(CALC, "A=B")
  field(INPA, "$(P):NOSAMPLES.VAL")
  field(OUT, "$(P):STARTAV CA")
  field(OOPT, "When Non-zero")
  field(DOPT, "Use OCAL")
}

# Flag to indicate that array needs to be reset.
record(longout, "$(P):RESETFLAG") {
  field(VAL, "1")
}

record(calcout, "$(P):NOSAMPLES") {
  field(DESC, "Calculates no of samples")
  field(CALC, "A*10")
}

record(calcout, "$(P):MONITORSTART") {
  field(CALC, "A=1")
  field(INPA, "$(P):STARTAV CP")
  field(OUT, "$(P):TRIGGERRESET.PROC PP")
  field(OOPT, "When Non-zero")
  field(DOPT, "Use CALC")
}
