#! Generated by VisualDCT v2.7.1-SNAPSHOT

# #################################################################################
# Database to fan out a global integration time to four channels (e.g. on a BPM)
# using movingAverage.template.  Also gives a global busy record to restart the
# averaging on all channels.
# 
# Macros:
# % macro, P, group device name
# % macro, CH1, PVs corresponding to the device names used in movingAverage.template
# % macro, CH2, PVs corresponding to the device names used in movingAverage.template
# % macro, CH3, PVs corresponding to the device names used in movingAverage.template
# % macro, CH4, PVs corresponding to the device names used in movingAverage.template
# 
# #################################################################################
# 
# Global integration time
# % archiver 1 Monitor
record(ao, "$(P):INTTIME") {
  field(DESC, "Integration time")
  field(FLNK, "$(P):INTFANOUT")
  field(PREC, "1")
  field(EGU, "s")
  field(LOPR, "0.1")
  field(VAL, "0.1")
  field(PINI, "YES")
}

# Fanout the integration time for a bpm to all channels
record(dfanout, "$(P):INTFANOUT") {
  field(SCAN, "Passive")
  field(SELM, "All")
  field(OUTA, "$(CH1):MOVINGINTTIME PP")
  field(OUTB, "$(CH2):MOVINGINTTIME PP")
  field(OUTC, "$(CH3):MOVINGINTTIME PP")
  field(OUTD, "$(CH4):MOVINGINTTIME PP")
  field(DOL, "$(P):INTTIME.VAL")
  field(OMSL, "closed_loop")
  field(DESC, "Integration time fanout")
}

# When the busy record for each channel has been reset, notify the
# global busy record.
record(calcout, "$(P):NOTIFY") {
  field(OUT, "$(P):STARTCOUNT.VAL CA")
  field(CALC, "!A&&!B&&!C&&!D")
  field(INPA, "$(CH1):STARTAV CP")
  field(INPB, "$(CH2):STARTAV CP")
  field(INPC, "$(CH3):STARTAV CP")
  field(INPD, "$(CH4):STARTAV CP")
  field(OOPT, "When Non-zero")
  field(DOPT, "Use OCAL")
}

# Write 1 to start averaging on all channels
record(busy, "$(P):STARTCOUNT") {
}

# Fanout the trigger to the busy record of each channel
record(dfanout, "$(P):STARTFANOUT") {
  field(SCAN, "Passive")
  field(SELM, "All")
  field(DOL, "$(P):STARTCOUNT.VAL CP")
  field(OUTA, "$(CH1):STARTAV CA")
  field(OUTB, "$(CH2):STARTAV CA")
  field(OUTC, "$(CH3):STARTAV CA")
  field(OUTD, "$(CH4):STARTAV CA")
  field(OMSL, "closed_loop")
}
